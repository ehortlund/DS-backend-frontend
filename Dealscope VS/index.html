<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dealscope</title>
    <link rel="icon" href="/assets/FAVICON.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>

  <body>
    <!-- Header -->
    <header class="main-header">
        <!-- Klickbar Logotyp -->
        <a href="index.html">
          <img id="header-logo" class="logo" src="assets/DS LOGO laying.svg" alt="DealScope Logo">
        </a>

        <!-- Mobilmenyn -->
        <div class="mobile-menu">
            <!-- Hamburgarikonen -->
            <button class="menu-btn" aria-label="Open menu"></button>

            <!-- Själva mobilnavigeringen -->
            <nav class="mobile-nav" id="mobile-nav">
                <a href="deals.html">Deals</a>
                <a href="index.html">Home</a>
                <a href="plans.html">Plans</a>
                <a href="FAQ.html">FAQ</a> 
                <a class="login-btn" href="login.html">Log in</a>
                <button class="theme-toggle-btn" aria-label="Toggle Theme">
                  <img id="mobile-moon-icon" class="theme-icon moon-icon" src="assets/Moon red.svg" alt="Moon Icon">
                  <img id="mobile-sun-icon" class="theme-icon sun-icon" src="assets/Sun red.svg" alt="Sun Icon">
              </button>
            </nav>
        </div>

        <!-- Desktop Navigation -->
        <nav class="desktop-nav">
            <a href="deals.html">Deals</a>
            <a href="index.html">Home</a>
            <a href="plans.html">Plans</a>
            <a href="FAQ.html">FAQ</a> 
            <a class="login-btn" href="login.html">Log in</a>
            <button class="theme-toggle-btn" aria-label="Toggle Theme">
              <img id="desktop-moon-icon" class="theme-icon moon-icon" src="assets/Moon red.svg" alt="Moon Icon">
              <img id="desktop-sun-icon" class="theme-icon sun-icon" src="assets/Sun red.svg" alt="Sun Icon">
          </button>
        </nav>
    </header>

    <!-- Main-innehåll -->
    <main>
      <!-- Hero-sektion -->
      <section class="hero fade-in">
        <img id="hero-circle" class="circle-icon fade-in" src="assets/DS CIRCLE.svg" alt="Circle Icon">
        <h1 class="fade-in">
          See the hidden market movers in <span class="highlight">real time.</span>
        </h1>
        <p class="fade-in">Track major deals and their supply chains.</p>
        <a href="plans.html" class="cta-btn fade-in">Try for free</a>
      </section>
    
      <!-- Funktioner-sektion -->
      <section class="features fade-in">
        <ul class="feature-list fade-in">
          <li class="feature-item fade-in">
            <div class="red-dot fade-in"></div>
            Full transparency in the supply chain
          </li>
          <li class="feature-item fade-in">
            <div class="red-dot fade-in"></div>
            Simplifies complex data
          </li>
          <li class="feature-item fade-in">
            <div class="red-dot fade-in"></div>
            Maps out which companies may benefit
          </li>
        </ul>
      </section>
    </main>
    
    <!-- Undersida-sektion -->
    <section class="insights-section fade-in">
      <div class="container fade-in">
        <h2 class="fade-in">
          Turn Insights into <span class="highlight2">Actionable</span> Opportunities
        </h2>
        <p class="subheading fade-in">
          Uncover hidden market dynamics and act with precision.
        </p>

        <ul class="benefits-list fade-in">
          <li class="fade-in">
            <div class="line left fade-in"></div> <!-- Vänster linje -->
            <div class="content fade-in">
              <span class="icon fade-in">
                <img src="assets/icons/icon-earth.svg" alt="Global Deals Icon">
              </span>
              <span class="text fade-in">
                <strong>Global Deals:</strong> Follow the largest transactions across sectors in real-time.
              </span>
            </div>
            <div class="line right fade-in"></div> <!-- Höger linje -->
          </li>
          <li class="fade-in">
            <div class="line left fade-in"></div> <!-- Vänster linje -->
            <div class="content fade-in">
              <span class="icon fade-in">
                <img src="assets/icons/icon-finger.svg" alt="Simplified Icon">
              </span>
              <span class="text fade-in">
                <strong>Simplified:</strong> See deal insights in its purest form, no emotional fairy tales or long texts.
              </span>
            </div>
            <div class="line right fade-in"></div> <!-- Höger linje -->
          </li>
          <li class="fade-in">
            <div class="line left fade-in"></div> <!-- Vänster linje -->
            <div class="content fade-in">
              <span class="icon fade-in">
                <img src="assets/icons/icon-chain.svg" alt="Full Chain Icon">
              </span>
              <span class="text fade-in">
                <strong>Full Chain:</strong> Big deals involve many players, see both contractors & subcontractors.
              </span>
            </div>
            <div class="line right fade-in"></div> <!-- Höger linje -->
          </li>
        </ul>

        <button class="cta-btn fade-in">Register</button>
      </div>
    </section>

    <!-- Introduktionsrubrik -->
    <header class="noise-dealscope-header fade-in">
      <h1 class="noise-dealscope-heading fade-in"><span class="highlight2">Dealscope</span> Cuts the Noise</h1>
      <p class="noise-dealscope-subheading fade-in">No Gurus. No Speculation. Just Clear Insights for Everyday Investors.</p>
    </header>

    <!-- Deal Section -->
    <section class="noise-dealscope-section fade-in">
      <div class="container fade-in">
          <div class="noise-dealscope-container fade-in">
              <!-- Vänster sida: The Noise -->
              <div class="noise-box fade-in">
                  <h2 class="deal-example-title fade-in">The Noise</h2>
                  <p class="deal-example-subtitle fade-in">
                      Endless hype, speculation, and noise from forums, newsfeeds, and self-proclaimed gurus.
                  </p>
                  <div class="articles-container fade-in">
                      <div class="article fade-in">
                          <img src="assets/profile1.png" alt="Profile 1" class="article-profile-pic fade-in">
                          <div class="article-content fade-in">
                              <h3 class="fade-in">Market Guru Predicts 500% Surge!</h3>
                              <p class="fade-in">Another speculative post from a self-proclaimed expert floods the forums with hype...</p>
                          </div>
                      </div>
                      <div class="article fade-in">
                          <img src="assets/profile2.png" alt="Profile 2" class="article-profile-pic fade-in">
                          <div class="article-content fade-in">
                              <h3 class="fade-in">Top 10 Stocks to Buy Now!</h3>
                              <p class="fade-in">Endless clickbait articles with no real data – just guesses and noise...</p>
                          </div>
                      </div>
                      <div class="article fade-in">
                          <img src="assets/profile3.png" alt="Profile 3" class="article-profile-pic fade-in">
                          <div class="article-content fade-in">
                              <h3 class="fade-in">Insider Tips You Can’t Miss!</h3>
                              <p class="fade-in">Unverified rumors spread like wildfire, drowning out real opportunities...</p>
                          </div>
                      </div>
                      <div class="article fade-in">
                          <img src="assets/profile4.png" alt="Profile 4" class="article-profile-pic fade-in">
                          <div class="article-content fade-in">
                              <h3 class="fade-in">Will This Stock Crash?</h3>
                              <p class="fade-in">More speculation from newsfeeds – no facts, just fearmongering...</p>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Höger sida: Dealscope -->
              <div class="dealscope-box fade-in">
                  <h2 class="deal-example-title fade-in">Dealscope</h2>
                  <p class="deal-example-subtitle fade-in">
                    Clear Insights Straight From the Source.
                  </p>
                  <!-- Ditt befintliga dealkort -->
                  <div class="deal-example-card fade-in">
                      <h3 class="deal-section-heading fade-in">Major Contractors and Partners:</h3>
                      <ul class="fade-in">
                          <li class="fade-in">Buyer: <strong>Brazilian Air Force</strong></li>
                          <li class="fade-in">
                              Seller: <strong>Saab AB <span class="ticker-green">(SAAB-B)</span></strong>
                          </li>
                      </ul>

                      <h3 class="deal-section-heading fade-in">Deal overview:</h3>
                      <ul class="fade-in">
                          <li class="fade-in">Deal Value: $5 Billion</li>
                          <li class="fade-in">Industry: Defense and Aerospace</li>
                      </ul>

                      <h3 class="deal-section-heading fade-in">Subcontractors and Partners:</h3>
                      <ul class="fade-in">
                          <li class="fade-in">
                              <strong>Embraer S.A. <span class="ticker-green">(NYSE: ERJ)</span></strong>:
                              Local assembly, production.
                          </li>
                          <li class="fade-in">
                              <strong>AEL Sistemas <span class="ticker-private">(Private)</span></strong>:
                              Avionics systems integration and development.
                          </li>
                          <li class="fade-in">
                              <strong>GE Aviation <span class="ticker-green">(General Electric, NYSE: GE)</span></strong>:
                              Engines (F414-GE-39E) for the Gripen NG aircraft.
                          </li>
                          <li class="fade-in">
                              <strong>Saab Aerostructures (Part of Saab AB, <span class="ticker-green">SAAB-B</span>)</strong>:
                              Design and production of structural components.
                          </li>
                          <li class="fade-in">
                              <strong>Akaer Engenharia <span class="ticker-private">(Private)</span></strong>:
                              Structural engineering and fuselage components.
                          </li>
                      </ul>

                      <span class="stock-note fade-in">Green color: Stock name</span>
                  </div>
              </div>
          </div>
          <!-- CTA-knapp centrerad längst ner -->
          <button class="cta-btn fade-in">Explore More Deals</button>
      </div>
    </section>
    
    <section class="trusted-section fade-in">
      <div class="container fade-in">
        <!-- Flex-container för vänster (text/stats) och höger (knapp) -->
        <div class="trusted-content fade-in">
          <!-- Vänstra blocket: Titel + siffror -->
          <div class="trusted-stats-block fade-in">
            <h2 class="trusted-title fade-in">Trusted by</h2>
            <!-- Dina siffror -->
            <div class="trusted-stats fade-in">
              <div class="stat fade-in">
                <span class="number fade-in">400+</span>
                <span class="text fade-in">Users</span>
              </div>
              <h2 class="trusted-title fade-in">Used over</h2>
              <div class="stat fade-in">
                <span class="number fade-in">20 000+</span>
                <span class="text fade-in">Hours</span>
              </div>
            </div>
          </div>
          <!-- Höger: Knappen -->
          <button class="register-btn fade-in">Register</button>
        </div>
      </div>
    </section>
    
    <footer class="footer fade-in">
      <div class="footer-container fade-in">
        <!-- Vänster sektion -->
        <div class="footer-logo-section fade-in">
          <img id="footer-logo" src="assets/DS LOGO laying.svg" alt="DealScope Logo" class="footer-logo fade-in">
            <p class="fade-in">© 2025 DealScope. All rights reserved.</p>
        </div>

        <!-- Mitten sektion -->
        <div class="footer-links-section fade-in">
            <ul class="fade-in">
                <li class="fade-in"><a href="deals.html">Deals</a></li>
                <li class="fade-in"><a href="index.html">Home</a></li>
                <li class="fade-in"><a href="plans.html">Plans</a></li>
                <li class="fade-in"><a href="FAQ.html">Faq</a></li>
                <li class="fade-in"><a href="login.html">Log in</a></li>
            </ul>
        </div>

        <!-- Höger sektion -->
        <div class="footer-info-section fade-in">
            <ul class="fade-in">
                <li class="fade-in"><a href="mailto:info@dealscope.io">info@dealscope.io</a></li>
                <li class="fade-in">SE0206198616</li>
                <li class="fade-in"><a href="#privacy-policy">Privacy policy</a></li>
                <li class="fade-in"><a href="#cookies">Cookies</a></li>
            </ul>
        </div>
      </div>
    </footer>

    <!-- Overlay för profilsidan -->
    <div id="profile-overlay" class="profile-overlay fade-in"></div>

    <!-- Modal för profilsidan -->
    <div id="profile-modal" class="profile-modal fade-in">
      <div class="profile-modal-content fade-in">
          <span id="close-profile-modal" class="close-modal fade-in">×</span>
          <div class="profile-modal-inner fade-in">
              <!-- Sidomeny -->
              <nav class="profile-sidebar fade-in">
                  <ul class="fade-in">
                      <li class="fade-in"><a href="#" class="active" data-section="profile">Profile</a></li>
                      <li class="fade-in"><a href="#" data-section="payment-settings">Payment Settings</a></li>
                      <li class="fade-in"><a href="#" data-section="settings">Settings</a></li>
                      <li class="fade-in"><a href="#" data-section="contact">Contact</a></li>
                      <li class="fade-in"><a href="#" data-section="subscription">Subscription</a></li> <!-- Ny sektion -->
                      <li class="fade-in"><a href="#" id="logout-btn-modal">Log out</a></li>
                  </ul>
              </nav>
              <!-- Innehållsdel -->
              <div class="profile-content fade-in">
                  <!-- Profilsektion -->
                  <div id="profile-section" class="content-section active fade-in">
                      <h2 class="fade-in">Profile</h2>
                      <p class="fade-in">Username: <span id="profile-username"></span></p>
                      <p class="fade-in">Email: <span id="profile-email"></span></p>
                  </div>
                <!-- Betalningsinställningar -->
                <div id="payment-settings-section" class="content-section fade-in">
                  <h2 class="fade-in">Payment Settings</h2>
                  <p class="fade-in">Payment Method: <span id="payment-method">Not set</span></p>
                  <p class="fade-in">Next Payment: <span id="next-payment">Not set</span></p>
                  <a href="#" id="view-payment-history" class="fade-in">View Payment History</a>
                  <button id="add-payment-method" class="fade-in">Add/Change Payment Method</button>
                  <p id="payment-info-text" class="fade-in" style="display: none; color: #666;">Note: You can only use one payment method at a time.</p>
                  <p class="error fade-in" id="payment-error"></p>
                  <!-- Dolt formulär för Stripe Elements -->
                  <div id="payment-form-container" style="display: none;">
                      <form id="payment-form">
                          <div class="payment-field fade-in">
                              <label for="card-number">Card Number</label>
                              <div id="card-number-element"></div>
                          </div>
                          <div class="payment-field fade-in">
                              <label for="card-expiry">Expiry Date</label>
                              <div id="card-expiry-element"></div>
                          </div>
                          <div class="payment-field fade-in">
                              <label for="card-cvc">CVC</label>
                              <div id="card-cvc-element"></div>
                          </div>
                          <button type="submit" id="submit-payment" class="fade-in">Submit Payment Method</button>
                          <button type="button" id="cancel-payment" class="fade-in">Cancel</button>
                      </form>
                  </div>
                </div>
                  <!-- Profilinställningar -->
                  <div id="profile-settings-section" class="content-section fade-in">
                      <h2 class="fade-in">Profile Settings</h2>
                      <p class="fade-in">Update your profile information and preferences.</p>
                  </div>
                  <!-- Utloggning -->
                  <div class="content-section fade-in">
                      <button id="logout-btn" class="fade-in">Log out</button>

                </div>
                  <!-- Inställningar -->
                  <div id="settings-section" class="content-section fade-in">
                      <h2 class="fade-in">Settings</h2>
                      <p class="fade-in">Adjust your account settings, notifications, and preferences.</p>
                  </div>
                  <!-- Kontakt -->
                  <div id="contact-section" class="content-section fade-in">
                      <h2 class="fade-in">Contact</h2>
                      <p class="fade-in">Need help? Reach out to us at <a href="mailto:info@dealscope.io">info@dealscope.io</a>.</p>
                  </div>
                  <!-- Ny sektion för prenumeration -->
                  <div id="subscription-section" class="content-section fade-in">
                    <h2 class="fade-in">Subscription</h2>
                    <p class="fade-in">Manage plan: <span id="current-plan"></span></p>
                    <div class="custom-select fade-in">
                        <div class="select-selected" id="selected-plan">Select a plan</div>
                        <div class="select-items" id="plan-options">
                            <div class="select-item" data-value="pro">Pro - $14.99/month</div>
                            <div class="select-item" data-value="pro_yearly">Pro Yearly - $149/year</div>
                            <div class="select-item" data-value="cancel">Cancel Subscription</div>
                        </div>
                    </div>
                    <button id="save-subscription" class="fade-in">Save Changes</button>
                    <p class="error fade-in" id="subscription-error"></p>
                  </div>
              </div>
          </div>
      </div>
    </div>
    

  <!-- Script -->
  <script src="script.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
      document.addEventListener('DOMContentLoaded', async () => {
          const loginButtons = document.querySelectorAll('.login-btn');
          const profileModal = document.getElementById('profile-modal');
          const profileOverlay = document.getElementById('profile-overlay');
          const closeProfileModal = document.getElementById('close-profile-modal');
          const header = document.querySelector('.main-header');
          const sidebarLinks = document.querySelectorAll('.profile-sidebar a');
          const contentSections = document.querySelectorAll('.content-section');
          const logoutButton = document.getElementById('logout-btn');
          const profileUsername = document.getElementById('profile-username');
          const profileEmail = document.getElementById('profile-email');
          const registerButtons = document.querySelectorAll('.cta-btn, .register-btn');
          const headerLogo = document.getElementById('header-logo');
          const footerLogo = document.getElementById('footer-logo');
          const heroCircle = document.getElementById('hero-circle');
          const desktopMoonIcon = document.getElementById('desktop-moon-icon');
          const desktopSunIcon = document.getElementById('desktop-sun-icon');
          const mobileMoonIcon = document.getElementById('mobile-moon-icon');
          const mobileSunIcon = document.getElementById('mobile-sun-icon');
  
          // Hantera anpassad dropdown
          const select = document.querySelector('.custom-select');
          const selected = document.getElementById('selected-plan');
          const items = document.getElementById('plan-options');
          let selectedValue = '';
  
          selected.addEventListener('click', () => {
              select.classList.toggle('open');
              items.style.display = select.classList.contains('open') ? 'block' : 'none';
          });
  
          items.querySelectorAll('.select-item').forEach(item => {
              item.addEventListener('click', () => {
                  selectedValue = item.getAttribute('data-value');
                  selected.textContent = item.textContent;
                  select.classList.remove('open');
                  items.style.display = 'none';
              });
          });
  
          // Stäng dropdown vid klick utanför
          document.addEventListener('click', (e) => {
              if (!select.contains(e.target)) {
                  select.classList.remove('open');
                  items.style.display = 'none';
              }
          });
  
          // Lägg till save-subscription-funktionalitet
          const saveButton = document.getElementById('save-subscription');
          saveButton.addEventListener('click', () => {
              window.location.href = 'register.html'; // Exempel, ändra efter behov
          });
  
          // Intersection Observer för fade-in-animationer
          const fadeInElements = document.querySelectorAll('.fade-in');
          const observerOptions = {
              root: null,
              rootMargin: '0px',
              threshold: 0.1
          };
  
          const observer = new IntersectionObserver((entries, observer) => {
              entries.forEach(entry => {
                  if (entry.isIntersecting) {
                      entry.target.classList.add('show');
                      observer.unobserve(entry.target);
                  }
              });
          }, observerOptions);
  
          fadeInElements.forEach(element => {
              observer.observe(element);
          });
  
          // Funktion för att uppdatera SVG:er baserat på tema
          function updateSVGs(theme) {
              if (theme === 'bright') {
                  if (headerLogo) headerLogo.src = 'assets/DS LOGO laying bright.svg';
                  if (footerLogo) footerLogo.src = 'assets/DS LOGO laying bright.svg';
                  if (heroCircle) heroCircle.src = 'assets/DS CIRCLE bright.svg';
                  if (desktopMoonIcon) desktopMoonIcon.src = 'assets/Moon grey.svg';
                  if (desktopSunIcon) desktopSunIcon.src = 'assets/Sun red.svg';
                  if (mobileMoonIcon) mobileMoonIcon.src = 'assets/Moon grey.svg';
                  if (mobileSunIcon) mobileSunIcon.src = 'assets/Sun red.svg';
              } else {
                  if (headerLogo) headerLogo.src = 'assets/DS LOGO laying.svg';
                  if (footerLogo) footerLogo.src = 'assets/DS LOGO laying.svg';
                  if (heroCircle) heroCircle.src = 'assets/DS CIRCLE.svg';
                  if (desktopMoonIcon) desktopMoonIcon.src = 'assets/Moon red.svg';
                  if (desktopSunIcon) desktopSunIcon.src = 'assets/Sun grey.svg';
                  if (mobileMoonIcon) mobileMoonIcon.src = 'assets/Moon red.svg';
                  if (mobileSunIcon) mobileSunIcon.src = 'assets/Sun grey.svg';
              }
          }
  
          // Hämta tema från localStorage och tillämpa det vid sidladdning
          const savedTheme = localStorage.getItem('theme');
          if (savedTheme === 'bright') {
              document.documentElement.classList.add('bright-mode');
              updateSVGs('bright');
          } else {
              updateSVGs('dark');
          }
  
          // Lägg till klick-event för Register-knapparna
          registerButtons.forEach(button => {
              button.addEventListener('click', () => {
                  window.location.href = 'register.html';
              });
          });
  
          // Lägg till klick-event för temaväxlingsknapparna
          const themeToggleButtons = document.querySelectorAll('.theme-toggle-btn');
          themeToggleButtons.forEach(button => {
              button.addEventListener('click', () => {
                  const htmlElement = document.documentElement;
                  if (htmlElement.classList.contains('bright-mode')) {
                      htmlElement.classList.remove('bright-mode');
                      localStorage.setItem('theme', 'dark');
                      updateSVGs('dark');
                  } else {
                      htmlElement.classList.add('bright-mode');
                      localStorage.setItem('theme', 'bright');
                      updateSVGs('bright');
                  }
              });
          });
  
          // Funktion för att uppdatera login-knapparnas text och länk
          async function updateLoginButton() {
              try {
                  const response = await fetch('/api/users/me', {
                      method: 'GET',
                      credentials: 'include'
                  });
                  const data = await response.json();
                  if (data.error) {
                      loginButtons.forEach(button => {
                          button.textContent = 'Log in';
                          button.href = '/login.html';
                          button.removeEventListener('click', openProfileModal);
                      });
                  } else {
                      loginButtons.forEach(button => {
                          button.textContent = data.username;
                          button.href = '#';
                          button.addEventListener('click', openProfileModal);
                      });
                      if (profileUsername && profileEmail) {
                          profileUsername.textContent = data.username;
                          profileEmail.textContent = data.email;
                      }
                  }
              } catch (error) {
                  loginButtons.forEach(button => {
                      button.textContent = 'Log in';
                      button.href = '/login.html';
                      button.removeEventListener('click', openProfileModal);
                  });
              }
          }
  
          // Funktion för att hämta och visa betalningsdata
          async function updatePaymentSettings() {
              try {
                  const response = await fetch('/api/users/payment-methods', { credentials: 'include' });
                  const data = await response.json();
                  const paymentMethodsCount = data.paymentMethods ? data.paymentMethods.length : 0;
                  const paymentData = {
                      method: paymentMethodsCount ? `${data.paymentMethods[0].brand} ending in ${data.paymentMethods[0].last4}` : "Not set",
                      nextPayment: paymentMethodsCount ? "2025-07-20 - $14.99" : "Not set"
                  };
                  const paymentMethod = document.getElementById('payment-method');
                  const nextPayment = document.getElementById('next-payment');
                  if (paymentMethod) paymentMethod.textContent = paymentData.method;
                  if (nextPayment) nextPayment.textContent = paymentData.nextPayment;
                  return paymentMethodsCount; // Returnera antalet betalningsmetoder
              } catch (error) {
                  const paymentMethod = document.getElementById('payment-method');
                  const nextPayment = document.getElementById('next-payment');
                  if (paymentMethod) paymentMethod.textContent = "Error loading method";
                  if (nextPayment) nextPayment.textContent = "Error loading date";
                  return 0;
              }
          }
  
          // Funktion för att hantera betalningsåtgärder
          async function handlePaymentActions() {
              const addButton = document.getElementById('add-payment-method');
              const viewHistoryLink = document.getElementById('view-history-link'); // Fixat ID
              const errorElement = document.getElementById('payment-error');
              const paymentFormContainer = document.getElementById('payment-form-container');
              const paymentForm = document.getElementById('payment-form');
              const submitPaymentButton = document.getElementById('submit-payment');
              const cancelPaymentButton = document.getElementById('cancel-payment');
              const paymentInfoText = document.getElementById('payment-info-text');
              let hasPaymentMethod = false;
              let currentPaymentMethodId = null;
  
              let stripe = new Stripe('pk_test_51ROfEhH1luVXkHvVAMvbkZvnlRI6gUvPmPBTDyzZ5VRvHnAjKcbbwguHxRvShMZMcHrfYyKpAkGb6uc94fFO7vst00zSorgYA0');
              let elements = stripe.elements();
  
              let cardNumber = elements.create('cardNumber');
              let cardExpiry = elements.create('cardExpiry');
              let cardCvc = elements.create('cardCvc');
  
              cardNumber.mount('#card-number-element');
              cardExpiry.mount('#card-expiry-element');
              cardCvc.mount('#card-cvc-element');
  
              if (addButton) {
                  addButton.addEventListener('click', () => {
                      paymentFormContainer.style.display = 'block';
                      paymentInfoText.style.display = 'block';
                      errorElement.textContent = '';
                  });
              }
  
              if (submitPaymentButton) {
                  paymentForm.addEventListener('submit', async (event) => {
                      event.preventDefault();
                      try {
                          const { paymentMethod, error } = await stripe.createPaymentMethod({
                              type: 'card',
                              card: cardNumber,
                              billing_details: { name: 'Test User' }
                          });
                          if (error) {
                              errorElement.textContent = error.message;
                          } else {
                              currentPaymentMethodId = paymentMethod.id;
                              const paymentIntentResponse = await fetch('/api/create-payment-intent', {
                                  method: 'POST',
                                  credentials: 'include',
                                  headers: { 'Content-Type': 'application/json' },
                                  body: JSON.stringify({ amount: 1000, paymentMethodId: paymentMethod.id })
                              });
                              if (!paymentIntentResponse.ok) {
                                  const text = await paymentIntentResponse.text();
                                  errorElement.textContent = `HTTP error! status: ${paymentIntentResponse.status}, body: ${text || 'No response body'}`;
                                  return;
                              }
                              const paymentIntentData = await paymentIntentResponse.json();
                              if (paymentIntentData.error) {
                                  errorElement.textContent = paymentIntentData.error;
                              } else {
                                  const { paymentIntent, error: confirmError } = await stripe.confirmCardPayment(
                                      paymentIntentData.clientSecret,
                                      {
                                          payment_method: paymentMethod.id
                                      }
                                  );
                                  if (confirmError) {
                                      errorElement.textContent = confirmError.message;
                                  } else if (paymentIntent.status === 'succeeded') {
                                      // Uppdatera till det nya kortet som standard
                                      await fetch('/api/users/payment-methods', {
                                          method: 'POST',
                                          credentials: 'include',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify({ paymentMethodId: paymentMethod.id, makeDefault: true })
                                      });
                                      currentPaymentMethodId = paymentMethod.id;
                                      hasPaymentMethod = true;
                                      errorElement.textContent = 'Payment method added/updated successfully';
                                      await updatePaymentSettings(); // Omedelbar uppdatering
                                  } else if (paymentIntent.status === 'requires_action') {
                                      const { error: authError } = await stripe.handleCardAction(paymentIntent.client_secret);
                                      if (authError) {
                                          errorElement.textContent = authError.message;
                                      } else {
                                          // Uppdatera till det nya kortet som standard
                                          await fetch('/api/users/payment-methods', {
                                              method: 'POST',
                                              credentials: 'include',
                                              headers: { 'Content-Type': 'application/json' },
                                              body: JSON.stringify({ paymentMethodId: paymentMethod.id, makeDefault: true })
                                          });
                                          currentPaymentMethodId = paymentMethod.id;
                                          hasPaymentMethod = true;
                                          errorElement.textContent = 'Payment method authenticated and added successfully';
                                          await updatePaymentSettings(); // Omedelbar uppdatering
                                      }
                                  }
                              }
                          }
                      } catch (error) {
                          errorElement.textContent = 'Error adding payment method: ' + error.message;
                      }
                      setTimeout(() => {
                          errorElement.textContent = '';
                          paymentFormContainer.style.display = 'none';
                          paymentInfoText.style.display = 'none';
                          cardNumber.clear();
                          cardExpiry.clear();
                          cardCvc.clear();
                      }, 2000);
                      updatePaymentSettings();
                  });
              }
  
              if (cancelPaymentButton) {
                  cancelPaymentButton.addEventListener('click', () => {
                      paymentFormContainer.style.display = 'none';
                      paymentInfoText.style.display = 'none';
                      cardNumber.clear();
                      cardExpiry.clear();
                      cardCvc.clear();
                  });
              }
  
              if (viewHistoryLink) {
                  viewHistoryLink.addEventListener('click', (event) => {
                      event.preventDefault();
                      errorElement.textContent = 'Viewing payment history (simulated).';
                      setTimeout(() => {
                          errorElement.textContent = 'Payment history: [Simulated data: Transaction on 2025-06-01 - $14.99]';
                          setTimeout(() => {
                              errorElement.textContent = '';
                          }, 3000);
                      }, 500);
                  });
              }
          }
  
          // Funktion för att öppna profilsidan
          function openProfileModal(event) {
              event.preventDefault();
              profileModal.style.display = 'flex';
              profileOverlay.style.display = 'block';
              header.style.zIndex = '0';
          }
  
          // Funktion för att stänga profilsidan
          function closeProfileModalHandler() {
              profileModal.style.display = 'none';
              profileOverlay.style.display = 'none';
              header.style.zIndex = '1';
          }
  
          // Hantera sidomenyn
          sidebarLinks.forEach(link => {
              link.addEventListener('click', (event) => {
                  event.preventDefault();
                  const section = link.getAttribute('data-section');
                  if (section) {
                      sidebarLinks.forEach(l => l.classList.remove('active'));
                      contentSections.forEach(s => s.classList.remove('active'));
                      link.classList.add('active');
                      document.getElementById(`${section}-section`).classList.add('active');
                      if (section === 'payment-settings') {
                          updatePaymentSettings();
                      }
                  }
              });
          });
  
          // Hantera utloggning
          if (logoutButton) {
              logoutButton.addEventListener('click', (event) => {
                  event.preventDefault();
                  fetch('/api/users/logout', {
                      method: 'POST',
                      credentials: 'include'
                  })
                  .then(() => {
                      closeProfileModalHandler();
                      updateLoginButton();
                      window.location.replace('/login.html');
                  })
                  .catch(() => {
                      window.location.replace('/login.html');
                  });
              });
          }
  
          // Stäng modalen vid klick på krysset
          if (closeProfileModal) {
              closeProfileModal.addEventListener('click', closeProfileModalHandler);
          }
  
          // Kör vid sidladdning
          updateLoginButton();
          updatePaymentSettings();
          handlePaymentActions();
      });
</script>
</body>
</html>
