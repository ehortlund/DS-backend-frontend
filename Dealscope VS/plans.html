<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dealscope</title>
    <link rel="icon" href="/assets/FAVICON.png" type="image/x-icon">
    <link rel="stylesheet" href="plans.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="stripe-publishable-key" content="{{STRIPE_PUBLISHABLE_KEY}}">
</head>

<body>
    <!-- Header -->
    <header class="main-header">
        <!-- Klickbar Logotyp -->
        <a href="index.html">
            <img id="header-logo" class="logo" src="assets/DS LOGO laying.svg" alt="DealScope Logo">
        </a>

        <!-- Mobilmenyn -->
        <div class="mobile-menu">
            <!-- Hamburgarikonen -->
            <button class="menu-btn" aria-label="Open menu"></button>

            <!-- Själva mobilnavigeringen -->
            <nav class="mobile-nav" id="mobile-nav">
                <a href="deals.html">Deals</a>
                <a href="index.html">Home</a>
                <a href="plans.html">Plans</a>
                <a href="FAQ.html">FAQ</a> 
                <a class="login-btn" href="login.html">Log in</a>
                <button class="theme-toggle-btn" aria-label="Toggle Theme">
                    <img id="mobile-moon-icon" class="theme-icon moon-icon" src="assets/Moon red.svg" alt="Moon Icon">
                    <img id="mobile-sun-icon" class="theme-icon sun-icon" src="assets/Sun grey.svg" alt="Sun Icon">
                </button>
            </nav>
        </div>

        <!-- Desktop Navigation -->
        <nav class="desktop-nav">
            <a href="deals.html">Deals</a>
            <a href="index.html">Home</a>
            <a href="plans.html">Plans</a>
            <a href="FAQ.html">FAQ</a> 
            <a class="login-btn" href="#login">Log in</a>
            <button class="theme-toggle-btn" aria-label="Toggle Theme">
                <img id="desktop-moon-icon" class="theme-icon moon-icon" src="assets/Moon red.svg" alt="Moon Icon">
                <img id="desktop-sun-icon" class="theme-icon sun-icon" src="assets/Sun grey.svg" alt="Sun Icon">
            </button>
        </nav>
    </header>

    <section class="plans fade-in">
        <h1 class="plans-title fade-in">Plans</h1>
        <p class="plans-subtitle fade-in">Choose the right one for you</p>
        <div class="plan-container fade-in">
            <div class="plan pro fade-in">
                <div class="badge fade-in">Most popular</div>
                <h2 class="fade-in">PRO Monthly</h2>
                <div class="price-container fade-in">
                    <span class="price fade-in">14.90</span>
                    <span class="price-label fade-in">$ / month</span>
                </div>
                <ul class="fade-in">
                    <li class="fade-in">14 days free trial</li>
                    <li class="fade-in">Cancel anytime</li>
                    <li class="fade-in">100+ deals per month</li>
                    <li class="fade-in">Live notifications</li>
                </ul>
                <button class="select-plan fade-in" data-price="1490">Start Free Trial</button>
            </div>
            
            <div class="plan yearly fade-in">
                <div class="badge fade-in">Two months free</div>
                <h2 class="fade-in">PRO Yearly</h2>
                <div class="price-container fade-in">
                    <span class="price fade-in">0,5</span>
                    <span class="price-label fade-in">$ / year</span>
                </div>
                <ul class="fade-in">
                    <li class="fade-in">Two months free</li>
                    <li class="fade-in">Billed anually</li>
                    <li class="fade-in">100+ deals per month</li>
                    <li class="fade-in">Live notifications</li>
                </ul>
                <button class="select-plan fade-in" data-price="50">Choose</button>
            </div>
        </div>
    </section>

    <!-- Overlay för profilsidan -->
    <div id="profile-overlay" class="profile-overlay fade-in"></div>

    <!-- Modal för profilsidan -->
    <div id="profile-modal" class="profile-modal fade-in">
        <div class="profile-modal-content fade-in">
            <span id="close-profile-modal" class="close-modal fade-in">×</span>
            <div class="profile-modal-inner fade-in">
                <!-- Sidomeny -->
                <nav class="profile-sidebar fade-in">
                    <ul class="fade-in">
                        <li class="fade-in"><a href="#" class="active" data-section="profile">Profile</a></li>
                        <li class="fade-in"><a href="#" data-section="payment-settings">Payment Settings</a></li>
                        <li class="fade-in"><a href="#" data-section="settings">Settings</a></li>
                        <li class="fade-in"><a href="#" data-section="contact">Contact</a></li>
                        <li class="fade-in"><a href="#" id="logout-btn">Log out</a></li>
                    </ul>
                </nav>
                <!-- Innehållsdel -->
                <div class="profile-content fade-in">
                    <!-- Profilsektion -->
                    <div id="profile-section" class="content-section active fade-in">
                        <h2 class="fade-in">Profile</h2>
                        <p class="fade-in">Username: <span id="profile-username"></span></p>
                        <p class="fade-in">Email: <span id="profile-email"></span></p>
                    </div>
                    <!-- Betalningsinställningar -->
                    <div id="payment-settings-section" class="content-section fade-in">
                        <h2 class="fade-in">Payment Settings</h2>
                        <p class="fade-in">Manage your payment methods and subscription details here.</p>
                    </div>
                    <!-- Inställningar -->
                    <div id="settings-section" class="content-section fade-in">
                        <h2 class="fade-in">Settings</h2>
                        <p class="fade-in">Adjust your account settings, notifications, and preferences.</p>
                    </div>
                    <!-- Kontakt -->
                    <div id="contact-section" class="content-section fade-in">
                        <h2 class="fade-in">Contact</h2>
                        <p class="fade-in">Need help? Reach out to us at <a href="mailto:info@dealscope.io">info@dealscope.io</a>.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer fade-in">
        <div class="footer-container fade-in">
            <!-- Vänster sektion -->
            <div class="footer-logo-section fade-in">
                <img id="footer-logo" src="assets/DS LOGO laying.svg" alt="DealScope Logo" class="footer-logo fade-in">
                <p class="fade-in">© 2025 DealScope. All rights reserved.</p>
            </div>

            <!-- Mitten sektion -->
            <div class="footer-links-section fade-in">
                <ul class="fade-in">
                    <li class="fade-in"><a href="deals.html">Deals</a></li>
                    <li class="fade-in"><a href="index.html">Home</a></li>
                    <li class="fade-in"><a href="plans.html">Plans</a></li>
                    <li class="fade-in"><a href="FAQ.html">FAQ</a></li>
                    <li class="fade-in"><a href="login.html">Log in</a></li>
                </ul>
            </div>

            <!-- Höger sektion -->
            <div class="footer-info-section fade-in">
                <ul class="fade-in">
                    <li class="fade-in"><a href="mailto:info@dealscope.io">info@dealscope.io</a></li>
                    <li class="fade-in">SE0206198616</li>
                    <li class="fade-in"><a href="#privacy-policy">Privacy policy</a></li>
                    <li class="fade-in"><a href="#cookies">Cookies</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <!-- Script -->
    <script src="script.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const stripePublishableKey = document.querySelector('meta[name="stripe-publishable-key"]').content;
            if (!stripePublishableKey) {
                console.error('Stripe Publishable Key is missing');
                return;
            }
            const stripe = Stripe(stripePublishableKey);
    
            const planButtons = document.querySelectorAll('.select-plan');
            console.log('Found plan buttons:', planButtons.length); // Felsökning
            const errorElement = document.getElementById('error-message') || document.createElement('div'); // Säkerställ errorElement
    
            if (planButtons.length === 0) {
                console.error('No elements with class .select-plan found');
                errorElement.textContent = 'No plan buttons found. Check HTML structure.';
                document.body.appendChild(errorElement);
                return;
            }
    
            planButtons.forEach(button => {
                console.log('Adding event listener to button:', button.textContent, 'with data-price:', button.getAttribute('data-price')); // Felsökning
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const amount = parseInt(button.getAttribute('data-price'));
                    const planName = button.closest('.plan')?.querySelector('h2')?.textContent || 'Unknown Plan';
                    console.log('Button clicked:', planName, 'Amount:', amount); // Felsökning
    
                    if (!amount || isNaN(amount)) {
                        console.error('Invalid amount:', button.getAttribute('data-price'));
                        errorElement.textContent = 'Invalid plan amount.';
                        return;
                    }
    
                    try {
                        console.log('Creating checkout session for amount:', amount, 'plan:', planName, 'User authenticated:', !!document.cookie.includes('token'));
                        const response = await fetch('/api/create-checkout-session', {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ amount, planName })
                        });
    
                        if (!response.ok) {
                            const text = await response.text();
                            errorElement.textContent = `Error: ${text || 'Server error'}`;
                            console.error('Checkout session error:', text);
                            return;
                        }
    
                        const { id: sessionId } = await response.json();
                        console.log('Checkout session ID:', sessionId);
    
                        const { error } = await stripe.redirectToCheckout({
                            sessionId: sessionId
                        });
    
                        if (error) {
                            errorElement.textContent = `Error redirecting to Checkout: ${error.message}`;
                            console.error('Error redirecting to Checkout:', error);
                        }
                    } catch (error) {
                        errorElement.textContent = `Error creating checkout session: ${error.message}`;
                        console.error('Error creating checkout session:', error);
                    }
                });
            });
    
            const loginButtons = document.querySelectorAll('.login-btn');
            const header = document.querySelector('.main-header');
            const profileModal = document.getElementById('profile-modal');
            const profileOverlay = document.getElementById('profile-overlay');
            const closeProfileModal = document.getElementById('close-profile-modal');
            const sidebarLinks = document.querySelectorAll('.profile-sidebar a');
            const contentSections = document.querySelectorAll('.content-section');
            const logoutButton = document.getElementById('logout-btn');
            const profileUsername = document.getElementById('profile-username');
            const profileEmail = document.getElementById('profile-email');
            const headerLogo = document.getElementById('header-logo');
            const footerLogo = document.getElementById('footer-logo');
            const desktopMoonIcon = document.getElementById('desktop-moon-icon');
            const desktopSunIcon = document.getElementById('desktop-sun-icon');
            const mobileMoonIcon = document.getElementById('mobile-moon-icon');
            const mobileSunIcon = document.getElementById('mobile-sun-icon');
    
            const fadeInElements = document.querySelectorAll('.fade-in');
            const observerOptions = {
                root: null,
                rootMargin: '0px',
                threshold: 0.1
            };
    
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('show');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);
    
            fadeInElements.forEach(element => {
                observer.observe(element);
            });
    
            function updateSVGs(theme) {
                if (theme === 'bright') {
                    if (headerLogo) headerLogo.src = 'assets/DS LOGO laying bright.svg';
                    if (footerLogo) footerLogo.src = 'assets/DS LOGO laying bright.svg';
                    if (desktopMoonIcon) desktopMoonIcon.src = 'assets/Moon grey.svg';
                    if (desktopSunIcon) desktopSunIcon.src = 'assets/Sun red.svg';
                    if (mobileMoonIcon) mobileMoonIcon.src = 'assets/Moon grey.svg';
                    if (mobileSunIcon) mobileSunIcon.src = 'assets/Sun red.svg';
                } else {
                    if (headerLogo) headerLogo.src = 'assets/DS LOGO laying.svg';
                    if (footerLogo) footerLogo.src = 'assets/DS LOGO laying.svg';
                    if (desktopMoonIcon) desktopMoonIcon.src = 'assets/Moon red.svg';
                    if (desktopSunIcon) desktopSunIcon.src = 'assets/Sun grey.svg';
                    if (mobileMoonIcon) mobileMoonIcon.src = 'assets/Moon red.svg';
                    if (mobileSunIcon) mobileSunIcon.src = 'assets/Sun grey.svg';
                }
            }
    
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'bright') {
                document.documentElement.classList.add('bright-mode');
                updateSVGs('bright');
            } else {
                updateSVGs('dark');
            }
    
            const themeToggleButtons = document.querySelectorAll('.theme-toggle-btn');
            themeToggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const htmlElement = document.documentElement;
                    if (htmlElement.classList.contains('bright-mode')) {
                        htmlElement.classList.remove('bright-mode');
                        localStorage.setItem('theme', 'dark');
                        updateSVGs('dark');
                    } else {
                        htmlElement.classList.add('bright-mode');
                        localStorage.setItem('theme', 'bright');
                        updateSVGs('bright');
                    }
                });
            });
    
            async function updateLoginButton() {
                try {
                    const response = await fetch('/api/users/me', {
                        method: 'GET',
                        credentials: 'include'
                    });
    
                    const data = await response.json();
    
                    if (data.error) {
                        loginButtons.forEach(button => {
                            button.textContent = 'Log in';
                            button.href = '/login.html';
                            button.removeEventListener('click', openProfileModal);
                        });
                        return;
                    }
    
                    loginButtons.forEach(button => {
                        button.textContent = data.username;
                        button.href = '#';
                        button.addEventListener('click', openProfileModal);
                    });
    
                    if (profileUsername && profileEmail) {
                        profileUsername.textContent = data.username;
                        profileEmail.textContent = data.email;
                    }
    
                    if (data.hasPaid) {
                        window.location.replace('/deals.html');
                        return;
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    loginButtons.forEach(button => {
                        button.textContent = 'Log in';
                        button.href = '/login.html';
                        button.removeEventListener('click', openProfileModal);
                    });
                }
            }
    
            function openProfileModal(event) {
                event.preventDefault();
                profileModal.style.display = 'flex';
                profileOverlay.style.display = 'block';
                header.style.zIndex = '0';
            }
    
            function closeProfileModalHandler() {
                profileModal.style.display = 'none';
                profileOverlay.style.display = 'none';
                header.style.zIndex = '1';
            }
    
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const section = link.getAttribute('data-section');
                    if (section) {
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        contentSections.forEach(s => s.classList.remove('active'));
                        link.classList.add('active');
                        document.getElementById(`${section}-section`).classList.add('active');
                    }
                });
            });
    
            if (logoutButton) {
                logoutButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    fetch('/api/users/logout', {
                        method: 'POST',
                        credentials: 'include'
                    })
                    .then(() => {
                        closeProfileModalHandler();
                        updateLoginButton();
                        window.location.replace('/login.html');
                    })
                    .catch(() => {
                        window.location.replace('/login.html');
                    });
                });
            }
    
            if (closeProfileModal) {
                closeProfileModal.addEventListener('click', closeProfileModalHandler);
            }
    
            updateLoginButton();
        });
    
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success')) {
                alert('Payment successful! Verifying login...');
                updateLoginButton(); // Uppdatera inloggningstillstånd
                setTimeout(() => { // Försök igen efter kort fördröjning
                    if (document.cookie.includes('token')) {
                        window.location.replace('/deals.html');
                    } else {
                        window.location.replace('/login.html');
                    }
                }, 1000); // 1 sekund fördröjning
            } else if (urlParams.get('cancel')) {
                alert('Payment canceled. Please try again.');
                window.history.replaceState({}, document.title, '/plans.html');
            }
        });
    </script>
</body>
</html>