<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dealscope</title>
    <link rel="icon" href="/assets/FAVICON.png" type="image/x-icon">
    <link rel="stylesheet" href="plans.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  </head>

<body>

      <!-- Header -->
      <header class="main-header">
        <!-- Klickbar Logotyp -->
        <a href="index.html">
          <img class="logo" src="assets/DS LOGO laying.svg" alt="DealScope Logo">
        </a>

          <!-- Mobilmenyn -->
          <div class="mobile-menu">
            <!-- Hamburgarikonen -->
            <button class="menu-btn" aria-label="Open menu"></button>

            <!-- Själva mobilnavigeringen -->
            <nav class="mobile-nav" id="mobile-nav">
                <a href="deals.html">Deals</a>
                <a href="index.html">Home</a>
                <a href="plans.html">Plans</a>
                <a href="FAQ.html">FAQ</a> 
                <a class="login-btn" href="login.html">Log in</a>
            </nav>
          </div>

        <!-- Desktop Navigation -->
        <nav class="desktop-nav">
            <a href="deals.html">Deals</a>
            <a href="index.html">Home</a>
            <a href="plans.html">Plans</a>
            <a href="FAQ.html">FAQ</a> 
            <a class="login-btn" href="#login">Log in</a>
        </nav>

        
    </header>

    <section class="plans fade-in show">
        <h1 class="plans-title">Plans</h1>
        <p class="plans-subtitle">Choose the right one for you</p>
        <div class="plan-container">
            <div class="plan pro">
                <div class="badge">Most popular</div>
                <h2>Pro</h2>
                <div class="price-container">
                    <span class="price">14.99</span>
                    <span class="price-label">$ / month</span>
                </div>
                <ul>
                    <li>14 days free trial</li>
                    <li>Cancel anytime</li>
                    <li>100+ deals per month</li>
                    <li>Live notifications</li>
                </ul>
                <button class="select-plan" data-price="1499">Start free trial</button>
            </div>
            
            <div class="plan yearly">
                <div class="badge">Two months free</div>
                <h2>Pro Yearly</h2>
                <div class="price-container">
                    <span class="price">149</span>
                    <span class="price-label">$ / year</span>
                </div>
                <ul>
                    <li>Two months free</li>
                    <li>Billed anually</li>
                    <li>100+ deals per month</li>
                    <li>Live notifications</li>
                </ul>
                <button class="select-plan" data-price="14900">Choose</button>
            </div>
        </div>
        
        <!-- Overlay för att tona ner bakgrunden -->
        <div id="payment-overlay" class="payment-overlay"></div>

        <!-- Modal för betalningsformulär -->
        <div id="payment-modal" class="payment-modal">
            <div class="payment-modal-content">
                <span id="close-modal" class="close-modal">×</span>
                <h2>Complete Your Payment</h2>
                <div class="payment-field">
                    <label for="card-number-element">Card Number</label>
                    <div id="card-number-element"></div>
                </div>
                <div class="payment-field">
                    <label for="card-expiry-element">Expiration Date</label>
                    <div id="card-expiry-element"></div>
                </div>
                <div class="payment-field">
                    <label for="card-cvc-element">CVC</label>
                    <div id="card-cvc-element"></div>
                </div>
                <button id="submit-payment">Pay Now</button>
                <div id="error"></div>

                <div class="payment-icons">
                    <img src="assets/paymenticons/klarna.svg" alt="Klarna">
                    <img src="assets/paymenticons/google-pay.svg" alt="Google Pay">
                    <img src="assets/paymenticons/visa.svg" alt="Visa">
                    <img src="assets/paymenticons/mastercard.svg" alt="Mastercard">
                    <img src="assets/paymenticons/apple-pay.svg" alt="Apple Pay">
                </div>

            </div>
        </div>
    </section>

        <!-- Overlay för profilsidan -->
        <div id="profile-overlay" class="profile-overlay"></div>

        <!-- Modal för profilsidan -->
        <div id="profile-modal" class="profile-modal">
            <div class="profile-modal-content">
                <span id="close-profile-modal" class="close-modal">×</span>
                <div class="profile-modal-inner">
                    <!-- Sidomeny -->
                    <nav class="profile-sidebar">
                        <ul>
                            <li><a href="#" class="active" data-section="profile">Profile</a></li>
                            <li><a href="#" data-section="payment-settings">Payment Settings</a></li>
                            <li><a href="#" data-section="settings">Settings</a></li>
                            <li><a href="#" data-section="contact">Contact</a></li>
                            <li><a href="#" id="logout-btn">Log out</a></li>
                        </ul>
                    </nav>
                    <!-- Innehållsdel -->
                    <div class="profile-content">
                        <!-- Profilsektion -->
                        <div id="profile-section" class="content-section active">
                            <h2>Profile</h2>
                            <p>Username: <span id="profile-username"></span></p>
                            <p>Email: <span id="profile-email"></span></p>
                        </div>
                        <!-- Betalningsinställningar -->
                        <div id="payment-settings-section" class="content-section">
                            <h2>Payment Settings</h2>
                            <p>Manage your payment methods and subscription details here.</p>
                        </div>
                        <!-- Inställningar -->
                        <div id="settings-section" class="content-section">
                            <h2>Settings</h2>
                            <p>Adjust your account settings, notifications, and preferences.</p>
                        </div>
                        <!-- Kontakt -->
                        <div id="contact-section" class="content-section">
                            <h2>Contact</h2>
                            <p>Need help? Reach out to us at <a href="mailto:info@dealscope.io">info@dealscope.io</a>.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <footer class="footer">
        <div class="footer-container">
          <!-- Vänster sektion -->
          <div class="footer-logo-section">
              <img src="assets/DS LOGO laying.svg" alt="DealScope Logo" class="footer-logo">
              <p>© 2025 DealScope. All rights reserved.</p>
          </div>
  
          <!-- Mitten sektion -->
          <div class="footer-links-section">
              <ul>
                  <li><a href="deals.html">Deals</a></li>
                  <li><a href="index.html">Home</a></li>
                  <li><a href="plans.html">Plans</a></li>
                  <li><a href="FAQ.html">FAQ</a></li>
                  <li><a href="login.html">Log in</a></li>
              </ul>
          </div>
  
          <!-- Höger sektion -->
          <div class="footer-info-section">
              <ul>
                  <li><a href="mailto:info@dealscope.io">info@dealscope.io</a></li>
                  <li>SE0206198616</li>
                  <li><a href="#privacy-policy">Privacy policy</a></li>
                  <li><a href="#cookies">Cookies</a></li>
              </ul>
          </div>
        </div>
      </footer>
  <!-- Script -->
  <script src="script.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const stripe = Stripe('pk_test_51ROfEhH1luVXkHvVAMvbkZvnlRI6gUvPmPBTDyzZ5VRvHnAjKcbbwguHxRvShMZMcHrfYyKpAkGb6uc94fFO7vst00zSorgYA0'); // Ersätt med din Publishable key från Stripe
    let elements;
        let selectedAmount = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const planButtons = document.querySelectorAll('.select-plan');
            const paymentModal = document.getElementById('payment-modal');
            const paymentOverlay = document.getElementById('payment-overlay');
            const closePaymentModal = document.getElementById('close-modal');
            const loginButtons = document.querySelectorAll('.login-btn');
            const header = document.querySelector('.main-header');
            const profileModal = document.getElementById('profile-modal');
            const profileOverlay = document.getElementById('profile-overlay');
            const closeProfileModal = document.getElementById('close-profile-modal');
            const sidebarLinks = document.querySelectorAll('.profile-sidebar a');
            const contentSections = document.querySelectorAll('.content-section');
            const logoutButton = document.getElementById('logout-btn');
            const profileUsername = document.getElementById('profile-username');
            const profileEmail = document.getElementById('profile-email');
            const errorElement = document.getElementById('error');

            // Funktion för att uppdatera login-knapparnas text och länk
            async function updateLoginButton() {
                try {
                    const response = await fetch('/api/users/me', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (data.error) {
                        // Användaren är inte inloggad, omdirigera till login
                        loginButtons.forEach(button => {
                            button.textContent = 'Log in';
                            button.href = '/login.html';
                            button.removeEventListener('click', openProfileModal);
                        });
                        window.location.replace('/login.html');
                        return;
                    }

                    // Användaren är inloggad, visa användarnamnet
                    loginButtons.forEach(button => {
                        button.textContent = data.username;
                        button.href = '#';
                        button.addEventListener('click', openProfileModal);
                    });

                    // Fyll i profilinformation
                    if (profileUsername && profileEmail) {
                        profileUsername.textContent = data.username;
                        profileEmail.textContent = data.email;
                    }

                    // Om användaren har betalat, omdirigera till deals.html
                    if (data.hasPaid) {
                        window.location.replace('/deals.html');
                        return;
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    loginButtons.forEach(button => {
                        button.textContent = 'Log in';
                        button.href = '/login.html';
                        button.removeEventListener('click', openProfileModal);
                    });
                    window.location.replace('/login.html');
                }
            }

            // Funktion för att öppna profilsidan
            function openProfileModal(event) {
                event.preventDefault();
                profileModal.style.display = 'flex';
                profileOverlay.style.display = 'block';
                header.style.zIndex = '0';
            }

            // Funktion för att stänga profilsidan
            function closeProfileModalHandler() {
                profileModal.style.display = 'none';
                profileOverlay.style.display = 'none';
                header.style.zIndex = '1';
            }

            // Hantera sidomenyn
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const section = link.getAttribute('data-section');
                    if (section) {
                        // Ta bort "active"-klassen från alla länkar och sektioner
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        contentSections.forEach(s => s.classList.remove('active'));

                        // Lägg till "active"-klassen på den valda länken och sektionen
                        link.classList.add('active');
                        document.getElementById(`${section}-section`).classList.add('active');
                    }
                });
            });

            // Hantera utloggning
            if (logoutButton) {
                logoutButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    fetch('/api/users/logout', {
                        method: 'POST',
                        credentials: 'include'
                    })
                    .then(() => {
                        closeProfileModalHandler();
                        updateLoginButton();
                        window.location.replace('/login.html');
                    })
                    .catch(() => {
                        window.location.replace('/login.html');
                    });
                });
            }

            // Stäng profilsidan vid klick på krysset
            if (closeProfileModal) {
                closeProfileModal.addEventListener('click', closeProfileModalHandler);
            }

            // Kör vid sidladdning
            updateLoginButton();

            planButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    selectedAmount = parseInt(button.getAttribute('data-price'));
                    paymentModal.style.display = 'flex';
                    paymentOverlay.style.display = 'block';
                    header.style.zIndex = '0';
                    errorElement.textContent = 'Enter your payment details...';

                    try {
                        const response = await fetch('/api/create-payment-intent', {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ amount: selectedAmount })
                        });

                        const data = await response.json();

                        if (data.error) {
                            errorElement.textContent = data.error;
                            paymentModal.style.display = 'none';
                            paymentOverlay.style.display = 'none';
                            header.style.zIndex = '1';
                            return;
                        }

                        elements = stripe.elements();
                        const elementStyles = {
                            base: {
                                color: '#2B2A2A',
                                fontFamily: 'Poppins, sans-serif',
                                fontSize: '16px',
                                '::placeholder': {
                                    color: '#CCCCCC',
                                },
                            },
                            invalid: {
                                color: '#E02F2F',
                            },
                        };

                        const cardNumber = elements.create('cardNumber', { style: elementStyles });
                        const cardExpiry = elements.create('cardExpiry', { style: elementStyles });
                        const cardCvc = elements.create('cardCvc', { style: elementStyles });

                        cardNumber.mount('#card-number-element');
                        cardExpiry.mount('#card-expiry-element');
                        cardCvc.mount('#card-cvc-element');

                        const submitButton = document.getElementById('submit-payment');
                        submitButton.addEventListener('click', async () => {
                            submitButton.disabled = true;
                            errorElement.textContent = 'Processing payment...';

                            try {
                                const result = await stripe.confirmCardPayment(data.clientSecret, {
                                    payment_method: {
                                        card: cardNumber,
                                    },
                                });

                                if (result.error) {
                                    errorElement.textContent = result.error.message;
                                    submitButton.disabled = false;
                                    return;
                                }

                                if (result.paymentIntent.status === 'succeeded') {
                                    errorElement.textContent = 'Payment successful! Redirecting...';
                                    setTimeout(() => {
                                        window.location.replace('/deals.html');
                                    }, 2000);
                                }
                            } catch (error) {
                                errorElement.textContent = 'Error: ' + error.message;
                                submitButton.disabled = false;
                            }
                        });
                    } catch (error) {
                        errorElement.textContent = 'Error: ' + error.message;
                        paymentModal.style.display = 'none';
                        paymentOverlay.style.display = 'none';
                        header.style.zIndex = '1';
                    }
                });
            });

            closePaymentModal.addEventListener('click', () => {
                paymentModal.style.display = 'none';
                paymentOverlay.style.display = 'none';
                header.style.zIndex = '1';
                planButtons.forEach(btn => btn.style.display = 'block');
                errorElement.textContent = '';
            });
        });
    </script>
</body>
</html>
