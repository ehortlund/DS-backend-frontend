<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dealscope</title>
    <link rel="icon" href="/assets/FAVICON.png" type="image/x-icon">
    <link rel="stylesheet" href="deals.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>

<body>
    <!-- Header -->
    <header class="main-header">
        <a href="index.html">
          <img class="logo" src="assets/DS LOGO laying.svg" alt="DealScope Logo">
        </a>
        <div class="mobile-menu">
            <button class="menu-btn" aria-label="Open menu"></button>
            <nav class="mobile-nav" id="mobile-nav">
                <a href="#Deals">Deals</a>
                <a href="index.html">Home</a>
                <a href="plans.html">Plans</a>
                <a href="FAQ.html">FAQ</a> 
                <a class="login-btn" href="login.html">Log in</a>
            </nav>
        </div>
        <nav class="desktop-nav">
            <a href="#Deals">Deals</a>
            <a href="index.html">Home</a>
            <a href="plans.html">Plans</a>
            <a href="FAQ.html">FAQ</a> 
            <a class="login-btn" href="login.html">Log in</a>
            <button id="logout-btn" class="logout-btn">Log out</button>
        </nav>
    </header>

    <!-- Deal Section -->
    <section class="deal-section">
        
        <h2 class="deal-section-title fade-in">Deal Dashboard</h2>
        <div class="status-container fade-in">
          <div class="live-status-wrapper">
            <span class="live-status" id="live-status-text"></span>
          </div>
        </div>
        
        <div class="deal-dashboard-wrapper">
            <!-- Sökfält, kategori och sort by -->
                <div class="deal-controls">
                    <div class="search-container">
                        <input type="text" id="deal-search" placeholder="Search deals...">
                        <div id="deal-suggestions" class="suggestions-dropdown"></div>
                    </div>
                    <div class="category-container">
                        <input type="text" id="deal-category" placeholder="Category" readonly autocomplete="off" autocorrect="off" spellcheck="false">
                        <div id="category-suggestions" class="suggestions-dropdown"></div>
                    </div>
                    <div class="sort-by-container">
                        <input type="text" id="deal-sort" placeholder="Sort by" readonly autocomplete="off" autocorrect="off" spellcheck="false">
                        <div id="sort-suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>
            <div class="deals-container fade-in"></div>
            <div class="deal-details-header fade-in" style="display: none;">
                <h2>Deal Name</h2>
                <p>Deal Description</p>
            </div>
            <div class="deal-details-container fade-in" style="display: none;">
                <button class="back-button fade-in">Go back</button>
            </div>
        </div>

    </section>

        <!-- Overlay för profilsidan -->
        <div id="profile-overlay" class="profile-overlay"></div>

        <!-- Modal för profilsidan -->
        <div id="profile-modal" class="profile-modal">
            <div class="profile-modal-content">
                <span id="close-profile-modal" class="close-modal">×</span>
                <div class="profile-modal-inner">
                    <!-- Sidomeny -->
                    <nav class="profile-sidebar">
                        <ul>
                            <li><a href="#" class="active" data-section="profile">Profile</a></li>
                            <li><a href="#" data-section="payment-settings">Payment Settings</a></li>
                            <li><a href="#" data-section="settings">Settings</a></li>
                            <li><a href="#" data-section="contact">Contact</a></li>
                            <li><a href="#" id="logout-btn-modal">Log out</a></li>
                        </ul>
                    </nav>
                    <!-- Innehållsdel -->
                    <div class="profile-content">
                        <!-- Profilsektion -->
                        <div id="profile-section" class="content-section active">
                            <h2>Profile</h2>
                            <p>Username: <span id="profile-username"></span></p>
                            <p>Email: <span id="profile-email"></span></p>
                        </div>
                        <!-- Betalningsinställningar -->
                        <div id="payment-settings-section" class="content-section">
                            <h2>Payment Settings</h2>
                            <p>Manage your payment methods and subscription details here.</p>
                        </div>
                        <!-- Inställningar -->
                        <div id="settings-section" class="content-section">
                            <h2>Settings</h2>
                            <p>Adjust your account settings, notifications, and preferences.</p>
                        </div>
                        <!-- Kontakt -->
                        <div id="contact-section" class="content-section">
                            <h2>Contact</h2>
                            <p>Need help? Reach out to us at <a href="mailto:info@dealscope.io">info@dealscope.io</a>.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <footer class="footer">
      <div class="footer-container">
        <div class="footer-logo-section">
            <img src="assets/DS LOGO laying.svg" alt="DealScope Logo" class="footer-logo">
            <p>© 2025 DealScope. All rights reserved.</p>
        </div>
        <div class="footer-links-section">
            <ul>
                <li><a href="#tools">Tools</a></li>
                <li><a href="plans.html">Plans</a></li>
                <li><a href="FAQ.html">FAQ</a></li>
                <li><a href="login.html">Log in</a></li>
            </ul>
        </div>
        <div class="footer-info-section">
            <ul>
                <li><a href="mailto:info@dealscope.io">info@dealscope.io</a></li>
                <li>SE0206198616</li>
                <li><a href="#privacy-policy">Privacy policy</a></li>
                <li><a href="#cookies">Cookies</a></li>
            </ul>
        </div>
      </div>
    </footer>

    <!-- Ladda in script.js först -->
    <script src="script.js"></script>
    <!-- Ladda in live-status.js efter script.js -->
    <script src="live-status.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loginButtons = document.querySelectorAll('.login-btn');
            const profileModal = document.getElementById('profile-modal');
            const profileOverlay = document.getElementById('profile-overlay');
            const closeProfileModal = document.getElementById('close-profile-modal');
            const header = document.querySelector('.main-header');
            const sidebarLinks = document.querySelectorAll('.profile-sidebar a');
            const contentSections = document.querySelectorAll('.content-section');
            const logoutButton = document.getElementById('logout-btn');
            const logoutButtonModal = document.getElementById('logout-btn-modal');
            const profileUsername = document.getElementById('profile-username');
            const profileEmail = document.getElementById('profile-email');

            // Funktion för att uppdatera login-knapparnas text och länk
            async function updateLoginButton() {
                try {
                    const response = await fetch('/api/users/me', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (data.error) {
                        // Användaren är inte inloggad, omdirigera till login
                        loginButtons.forEach(button => {
                            button.textContent = 'Log in';
                            button.href = '/login.html';
                            button.removeEventListener('click', openProfileModal);
                        });
                        window.location.replace('/login.html');
                        return;
                    }

                    if (!data.hasPaid) {
                        // Användaren har inte betalat, omdirigera till plans
                        window.location.replace('/plans.html');
                        return;
                    }

                    // Användaren är inloggad och har betalat, visa användarnamnet
                    loginButtons.forEach(button => {
                        button.textContent = data.username;
                        button.href = '#';
                        button.addEventListener('click', openProfileModal);
                    });

                    // Fyll i profilinformation
                    if (profileUsername && profileEmail) {
                        profileUsername.textContent = data.username;
                        profileEmail.textContent = data.email;
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    loginButtons.forEach(button => {
                        button.textContent = 'Log in';
                        button.href = '/login.html';
                        button.removeEventListener('click', openProfileModal);
                    });
                    window.location.replace('/login.html');
                }
            }

            // Funktion för att öppna profilsidan
            function openProfileModal(event) {
                event.preventDefault();
                profileModal.style.display = 'flex';
                profileOverlay.style.display = 'block';
                header.style.zIndex = '0';
            }

            // Funktion för att stänga profilsidan
            function closeProfileModalHandler() {
                profileModal.style.display = 'none';
                profileOverlay.style.display = 'none';
                header.style.zIndex = '1';
            }

            // Hantera sidomenyn
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const section = link.getAttribute('data-section');
                    if (section) {
                        // Ta bort "active"-klassen från alla länkar och sektioner
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        contentSections.forEach(s => s.classList.remove('active'));

                        // Lägg till "active"-klassen på den valda länken och sektionen
                        link.classList.add('active');
                        document.getElementById(`${section}-section`).classList.add('active');
                    }
                });
            });

            // Hantera utloggning (både från header och modal)
            function handleLogout() {
                fetch('/api/users/logout', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(() => {
                    closeProfileModalHandler();
                    updateLoginButton();
                    window.location.replace('/login.html');
                })
                .catch(() => {
                    window.location.replace('/login.html');
                });
            }

            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }

            if (logoutButtonModal) {
                logoutButtonModal.addEventListener('click', (event) => {
                    event.preventDefault();
                    handleLogout();
                });
            }

            // Stäng profilsidan vid klick på krysset
            if (closeProfileModal) {
                closeProfileModal.addEventListener('click', closeProfileModalHandler);
            }

            // Kör vid sidladdning
            updateLoginButton();
        });
    </script>
</body>
</html>